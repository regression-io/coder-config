#!/bin/bash
# Auto-tag and push after every commit

# Skip if SKIP_AUTO_PUSH is set
if [ -n "$SKIP_AUTO_PUSH" ]; then
  exit 0
fi

# Skip if we're in a rebase or merge
if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ] || [ -f ".git/MERGE_HEAD" ]; then
  exit 0
fi

# Get version from package.json
VERSION=$(node -p "require('./package.json').version" 2>/dev/null)
if [ -z "$VERSION" ]; then
  exit 0
fi

TAG="v$VERSION"

# Check if tag already exists
if git rev-parse "$TAG" >/dev/null 2>&1; then
  exit 0
fi

# Create tag
git tag "$TAG"

# Push commit and tags
echo "ðŸš€ Pushing $TAG..."
git push && git push --tags

echo "âœ… Released $TAG - CI will publish to npm"
